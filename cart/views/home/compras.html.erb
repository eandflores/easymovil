<div id="Logo">
	<img src="img/Logo.png">
</div>
<div id="Compras" ></div>
<%
	precio_internet = 0 
	precio_normal = 0
%>
<ul id="Productos" class="Compras">
	<% @data.each do |i| %>
		<li id="Producto_<%= i[:id] %>" class="Producto">
			<img src="<%= i[:image_url] %>">
			<div class="DetalleProducto">
                <p class="Especificacion"><%= i[:name] %></p>
                <p class="Local"><%= i[:local] %></p>
                <p class="Numero"><%= i[:number] %></p>
                <p>Valor Caja</p>
                <% 
                	precio_internet += i[:price] * i[:quantity]
                	precio_normal += i[:normal_price] * i[:quantity]
                %>
                <p class="PrecioInternet">Internet <span><%= number_to_currency i[:price] %> (-<%= (100-(i[:price]*100.0)/i[:normal_price]).round %>%)</span></p>
                <p class="PrecioNormal"> Precio Normal <span><%= number_to_currency i[:normal_price] %></span></p>
            </div>
			<div class="ContenedorCantidad">
				<a class="CantMas" href="javascript:void(0)"></a>
				<div class="Cantidad" >
					<input name="Cantidad1" type="text" value="<%= i[:quantity] %>" class="entero" disabled>
				</div>
				<a class="CantMenos" href="javascript:void(0)"></a>
			</div>
		</li>
	<% end %>
</ul>
<div id="BarraInferior">
	<div id="TotalInternet">
		<p>Total Internet</p>
		<p><span><%= number_to_currency precio_internet %></span></p>
	</div>
	<div id="TotalNormal">
		<p>Total Normal</p>
		<p><span><%= number_to_currency precio_normal %></span></p>
	</div>
	<a id="btn_comprar" href="javascript:void()"><img src="img/SiguienteFinal.png"></a>
</div>
</div>
<script>
    function comprar(e)
    {
        e.preventDefault();
        // ESTA ES LA PARTE DONDE HAY QUE TENER CUIDADO,
        // HAY QUE GUARDAR EN ID EL ID QUE USA EASY PARA LOS PRODUCTOS.
        // ES EL PARÁMETRO ID_PROD DE LA URL DE UN PRODUCTO:
        // http://www.easy.cl/easy/ProductDisplay?mundo=1&id_prod=156828
        <% 
            str_inserta = ""
            @data.each_with_index do |i, k|
                str_inserta << "&id_prod_#{k}=#{i[:number]}&cantidad_l#{k}=#{i[:quantity]}"
            end 
            str_inserta << "&max_productos=#{@data.count}"
        %>
        $.ajax({
                url: '//www.easy.cl/easy/ShowInfoCarro',
                data: 'INSERTA=<%= str_inserta%>',
                cache: false,

                    // LOS DATOS TIENEN QUE SALIR EN JSONP PARA PERMITIR EL CROSS-DOMAIN
                dataType: 'jsonp',
                success: function () {
                    // ACCIONES PARA EL ÉXITO. NO SE USA.
                },
                error: function (a,b,c) {
                       // EL SCRIPT SIEMPRE VA A ARROJAR ERROR, PORQUE LOS DATOS
                    // NO VUELVEN EN JSON. HAY QUE USAR EL ERROR COMO CALLBACK
                    // PARA CONFIRMAR EL ÉXITO DE LA INYECCIÓN
                    
                    window.location = "http://www.easy.cl";
                    
                }
            });

    }
    $(document).ready(function(){
        $(".entero").numeric();
        $('#btn_comprar').click(comprar);
    })

    $('.CantMas').click(function(){
    	var contenedor = $(this).parent();
    	var input = contenedor.find("input");

    	input.attr({
    		'value' : parseInt(input.val())+1
    	});

    	var id = contenedor.parent().attr('id');
		var p_id = id.split("_")[1];
        $.get("<%= url(:api, :add_cart) %>/"+p_id, function(){
        	window.location = "<%= url(:home, :compras) %>";	
        });

        

    	
    })

    $('.CantMenos').click(function(){
    	var contenedor = $(this).parent();
    	var input = contenedor.find("input");

    	var numero = parseInt(input.val())
    	
    	if(numero > 0){
	    	input.attr({
	    		'value' : parseInt(input.val())-1
	    	});
	    }

	    var id = contenedor.parent().attr('id');
		var p_id = id.split("_")[1];
        $.get("<%= url(:api, :del_cart) %>/"+p_id, function(){
        	window.location = "<%= url(:home, :compras) %>";	
        });

    })
</script>